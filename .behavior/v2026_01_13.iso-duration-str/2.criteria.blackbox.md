# blackbox criteria: iso duration string support

experience bounds for iso 8601 duration string format support

---

# usecase.1 = declare duration via string format

given('a user declares a duration via iso 8601 string')
  when('the string is a valid time-only duration')
    then('type IsoDuration accepts "PT5S"')
      sothat('users can express 5 seconds concisely')
    then('type IsoDuration accepts "PT1H30M"')
      sothat('users can express 1 hour 30 minutes')
    then('type IsoDuration accepts "PT0S"')
      sothat('users can express zero duration')
    then('type IsoDuration accepts "PT0.5S"')
      sothat('users can express 500 milliseconds via fractional seconds')
    then('type IsoDuration accepts "PT0.001S"')
      sothat('users can express 1 millisecond via fractional seconds')
    then('type IsoDuration accepts "PT1.25S"')
      sothat('users can express 1250 milliseconds via fractional seconds')
  when('the string is a valid date-only duration')
    then('type IsoDuration accepts "P1Y"')
      sothat('users can express 1 year')
    then('type IsoDuration accepts "P6M"')
      sothat('users can express 6 months')
    then('type IsoDuration accepts "P2W"')
      sothat('users can express 2 weeks')
    then('type IsoDuration accepts "P30D"')
      sothat('users can express 30 days')
  when('the string is a valid combined duration')
    then('type IsoDuration accepts "P1Y6M15DT12H30M45S"')
      sothat('users can express complex durations')
    then('type IsoDuration accepts "P1DT2H"')
      sothat('users can express 1 day 2 hours')

# usecase.2 = declare duration via object format (current behavior)

given('a user declares a duration via object shape')
  when('the object has time-only fields')
    then('type IsoDuration accepts { seconds: 5 }')
      sothat('current behavior is preserved')
    then('type IsoDuration accepts { hours: 1, minutes: 30 }')
      sothat('current behavior is preserved')
  when('the object has date-only fields')
    then('type IsoDuration accepts { years: 1 }')
      sothat('current behavior is preserved')
    then('type IsoDuration accepts { months: 6 }')
      sothat('current behavior is preserved')
    then('type IsoDuration accepts { weeks: 2 }')
      sothat('current behavior is preserved')
    then('type IsoDuration accepts { days: 30 }')
      sothat('current behavior is preserved')
  when('the object has combined fields')
    then('type IsoDuration accepts { years: 1, months: 6, days: 15, hours: 12 }')
      sothat('current behavior is preserved')
  when('the object has milliseconds')
    then('type IsoDuration accepts { milliseconds: 500 }')
      sothat('sub-second precision is preserved')

# usecase.3 = validate duration strings

given('a user validates whether a string is a valid iso duration')
  when('the string is valid')
    then('isIsoDurationStr("PT5S") returns true')
    then('isIsoDurationStr("P1Y2M3DT4H5M6S") returns true')
    then('isIsoDurationStr("P0D") returns true')
  when('the string is invalid')
    then('isIsoDurationStr("5S") returns false')
      sothat('absent P designator is rejected')
    then('isIsoDurationStr("PT") returns false')
      sothat('empty time component is rejected')
    then('isIsoDurationStr("P") returns false')
      sothat('empty period is rejected')
    then('isIsoDurationStr("pt5s") returns false')
      sothat('lowercase designators are rejected')
    then('isIsoDurationStr("P5S") returns false')
      sothat('seconds without T designator are rejected')
    then('isIsoDurationStr("PT5M3S2H") returns false')
      sothat('wrong unit order is rejected')
    then('isIsoDurationStr("hello") returns false')
      sothat('arbitrary strings are rejected')
    then('isIsoDurationStr("") returns false')
      sothat('empty strings are rejected')

# usecase.4 = cast string to duration and vice versa

given('a user converts between duration formats')
  when('cast from string to object shape')
    then('asIsoDurationShape("PT5S") returns { seconds: 5 }')
    then('asIsoDurationShape("P1Y6M") returns { years: 1, months: 6 }')
    then('asIsoDurationShape("P1DT2H30M") returns { days: 1, hours: 2, minutes: 30 }')
    then('asIsoDurationShape("PT1.5S") returns { seconds: 1.5 }')
      sothat('fractional seconds are supported')
  when('cast from object shape to string')
    then('asIsoDurationWords({ seconds: 5 }) returns "PT5S"')
    then('asIsoDurationWords({ years: 1, months: 6 }) returns "P1Y6M"')
    then('asIsoDurationWords({ days: 1, hours: 2, minutes: 30 }) returns "P1DT2H30M"')
    then('asIsoDurationWords({ milliseconds: 500 }) returns "PT0.5S"')
      sothat('milliseconds are expressed as fractional seconds')

# usecase.5 = operations accept both formats isomorphically

given('a user uses addDuration with a timestamp')
  when('the duration is a string')
    then('addDuration("2024-01-01T00:00:00Z", "PT1H") returns "2024-01-01T01:00:00Z"')
      sothat('string durations work with addDuration')
  when('the duration is an object')
    then('addDuration("2024-01-01T00:00:00Z", { hours: 1 }) returns "2024-01-01T01:00:00Z"')
      sothat('object durations work with addDuration')
  when('equivalent formats are used')
    then('addDuration(stamp, "PT1H30M") equals addDuration(stamp, { hours: 1, minutes: 30 })')
      sothat('both formats produce identical results')

given('a user uses subDuration with a timestamp')
  when('the duration is a string')
    then('subDuration("2024-01-01T01:00:00Z", "PT1H") returns "2024-01-01T00:00:00Z"')
      sothat('string durations work with subDuration')
  when('the duration is an object')
    then('subDuration("2024-01-01T01:00:00Z", { hours: 1 }) returns "2024-01-01T00:00:00Z"')
      sothat('object durations work with subDuration')

given('a user uses toMilliseconds with a duration')
  when('the duration is a string')
    then('toMilliseconds("PT1H") returns 3600000')
      sothat('string durations convert to milliseconds')
  when('the duration is an object')
    then('toMilliseconds({ hours: 1 }) returns 3600000')
      sothat('object durations convert to milliseconds')
  when('equivalent formats are used')
    then('toMilliseconds("PT1H30M") equals toMilliseconds({ hours: 1, minutes: 30 })')
      sothat('both formats produce identical results')

given('a user uses sleep with a duration')
  when('the duration is a string')
    then('sleep("PT0.01S") pauses for ~10 milliseconds')
      sothat('string durations work with sleep')
  when('the duration is an object')
    then('sleep({ milliseconds: 10 }) pauses for ~10 milliseconds')
      sothat('object durations work with sleep')

given('a user uses waitFor with duration options')
  when('interval and timeout are strings')
    then('waitFor(fn, { interval: "PT0.01S", timeout: "PT1S" }) works')
      sothat('string durations work in options')
  when('interval and timeout are objects')
    then('waitFor(fn, { interval: { milliseconds: 10 }, timeout: { seconds: 1 } }) works')
      sothat('object durations work in options')

# usecase.6 = getDuration returns duration shape (not string)

given('a user computes duration from a range')
  when('getDuration is called')
    then('getDuration({ of: { range } }) returns an object shape')
      sothat('computed durations remain structured for manipulation')
  when('user wants string output')
    then('asIsoDurationWords(getDuration({ of: { range } })) returns string')
      sothat('users can convert to string when needed')

# usecase.7 = asDurationInWords supports both formats

given('a user wants human-readable duration text')
  when('the duration is a string')
    then('asDurationInWords("PT2H5M") returns "2h 5m"')
      sothat('string durations render as words')
  when('the duration is an object')
    then('asDurationInWords({ hours: 2, minutes: 5 }) returns "2h 5m"')
      sothat('object durations render as words')

# usecase.8 = edge cases and boundary conditions

given('a user works with edge case durations')
  when('duration has zero value')
    then('asIsoDurationWords({ seconds: 0 }) returns "PT0S"')
    then('asIsoDurationShape("PT0S") returns { seconds: 0 }')
  when('duration has fractional seconds')
    then('asIsoDurationWords({ seconds: 1.5 }) returns "PT1.5S"')
    then('asIsoDurationShape("PT1.5S") returns { seconds: 1.5 }')
  when('duration has milliseconds')
    then('asIsoDurationWords({ milliseconds: 100 }) returns "PT0.1S"')
    then('asIsoDurationWords({ seconds: 1, milliseconds: 500 }) returns "PT1.5S"')
      sothat('milliseconds merge into fractional seconds')
  when('duration string has large values')
    then('isIsoDurationStr("P100Y") returns true')
    then('isIsoDurationStr("PT9999H") returns true')
  when('duration has weeks')
    then('asIsoDurationWords({ weeks: 2 }) returns "P2W"')
    then('asIsoDurationShape("P2W") returns { weeks: 2 }')
    then('asIsoDurationWords({ weeks: 2, days: 3 }) returns "P2W3D"')
      sothat('weeks can combine with other date units')

# usecase.9 = type guards narrow IsoDuration type

given('a user needs to narrow IsoDuration type')
  when('check if a value is a duration string')
    then('isIsoDurationStr(value) narrows type to IsoDurationStr')
      sothat('typescript knows the string is valid')
  when('check if a value is a duration object')
    then('isIsoDurationShape(value) narrows type to IsoDurationShape')
      sothat('typescript knows the object is valid')
  when('check if a value is any duration')
    then('isIsoDuration(value) narrows type to IsoDuration')
      sothat('typescript knows the value is a valid duration')

# usecase.10 = stopwatch returns duration object

given('a user measures elapsed time with stopwatch')
  when('stopwatch.stop() is called')
    then('result.duration is an IsoDurationShape object')
      sothat('elapsed time can be manipulated programmatically')
  when('user wants string representation')
    then('asIsoDurationWords(result.duration) converts to string')
      sothat('elapsed time can be serialized')

---

# reference: iso 8601 duration format

format: `P[n]Y[n]M[n]DT[n]H[n]M[n]S` or `P[n]W`

designators:
- P = period (required at start)
- T = time separator (required before H/M/S)
- Y = years, M = months (before T), W = weeks, D = days
- H = hours, M = minutes (after T), S = seconds

examples:
- PT5S = 5 seconds
- PT1H30M = 1 hour 30 minutes
- P1Y = 1 year
- P6M = 6 months
- P2W = 2 weeks
- P30D = 30 days
- P1Y6M15DT12H30M45S = 1 year, 6 months, 15 days, 12 hours, 30 minutes, 45 seconds
- PT0.5S = 500 milliseconds (fractional seconds)

note: milliseconds are not an iso 8601 unit; they are expressed as fractional seconds
