# roadmap: iso duration string support

execution checklist for blueprint v1.i1

---

## prerequisites

- [ ] **pre.1** ensure build passes before changes
  - run: `npm run build`
  - verify: exit code 0
  - verify: no type errors

- [ ] **pre.2** ensure all tests pass before changes
  - run: `npm run test:types && npm run test:unit`
  - verify: exit code 0
  - verify: no test failures

---

## phase 0: domain objects

foundation types that enable the feature.

### step 0.1: create IsoDurationWords type

- [ ] **0.1.1** create `src/domain.objects/IsoDurationWords.ts`
  - acceptance: file exists with template literal union type
  - acceptance: exports `IsoDurationWords` type

- [ ] **0.1.2** create `src/domain.objects/IsoDurationWords.test.ts`
  - acceptance: test file exists with type fit tests
  - acceptance: covers time-only, date-only, combined patterns
  - acceptance: `@ts-expect-error` tests for invalid patterns

- [ ] **0.1.3** verify step 0.1
  - run: `npm run test:types`
  - verify: no type errors
  - run: `npm run test:unit -- IsoDurationWords`
  - verify: all tests pass

### step 0.2: create IsoDurationShape type

depends on: none (can run parallel with 0.1)

- [ ] **0.2.1** create `src/domain.objects/IsoDurationShape.ts`
  - acceptance: file exists with branded `PickAny<{...}>` type
  - acceptance: glossary brand is `'iso-time.IsoDurationShape | iso-time.IsoDuration'`
  - acceptance: exports `IsoDurationShape` type

- [ ] **0.2.2** create `src/domain.objects/IsoDurationShape.test.ts`
  - acceptance: test file exists with type fit tests
  - acceptance: covers valid duration objects
  - acceptance: `@ts-expect-error` tests for invalid shapes

- [ ] **0.2.3** verify step 0.2
  - run: `npm run test:types`
  - verify: no type errors
  - run: `npm run test:unit -- IsoDurationShape`
  - verify: all tests pass

### step 0.3: create unified IsoDuration type

depends on: 0.1, 0.2

- [ ] **0.3.1** update `src/domain.objects/IsoDuration.ts`
  - acceptance: imports `IsoDurationWords` and `IsoDurationShape`
  - acceptance: defines `IsoDuration` as branded union
  - acceptance: glossary brand is `'iso-time.IsoDuration'`
  - acceptance: re-exports constituent types

- [ ] **0.3.2** update `src/domain.objects/IsoDuration.test.ts`
  - acceptance: tests accept both string and object formats
  - acceptance: tests reject invalid formats via `@ts-expect-error`
  - acceptance: tests union assignment behavior

- [ ] **0.3.3** verify step 0.3
  - run: `npm run test:types`
  - verify: no type errors
  - run: `npm run test:unit -- IsoDuration`
  - verify: all tests pass

### phase 0 gate

- [ ] **0.gate** verify phase 0 complete
  - run: `npm run test:types && npm run test:unit`
  - verify: all tests pass
  - verify: `IsoDuration` accepts `'PT5S'`
  - verify: `IsoDuration` accepts `{ seconds: 5 }`

---

## phase 1: type guards

runtime validation for duration formats.

### step 1.1: create isIsoDurationWords guard

depends on: 0.1

- [ ] **1.1.1** create `src/domain.operations/checks/isIsoDurationWords.ts`
  - acceptance: exports `isIsoDurationWords` function
  - acceptance: uses `withAssure` from type-fns
  - acceptance: validates via regex pattern
  - acceptance: rejects `'P'`, `'PT'`, lowercase, wrong order

- [ ] **1.1.2** create `src/domain.operations/checks/isIsoDurationWords.test.ts`
  - acceptance: tests valid patterns: PT5S, P1Y2M3DT4H5M6S, P0D, PT0.5S, P100Y, PT9999H
  - acceptance: tests invalid patterns: 5S, PT, P, pt5s, P5S, PT5M3S2H, hello, ""

- [ ] **1.1.3** verify step 1.1
  - run: `npm run test:unit -- isIsoDurationWords`
  - verify: all tests pass

### step 1.2: create isIsoDurationShape guard

depends on: 0.2

- [ ] **1.2.1** create `src/domain.operations/checks/isIsoDurationShape.ts`
  - acceptance: exports `isIsoDurationShape` function
  - acceptance: uses `withAssure` from type-fns
  - acceptance: validates object keys and value types
  - acceptance: rejects empty objects

- [ ] **1.2.2** create `src/domain.operations/checks/isIsoDurationShape.test.ts`
  - acceptance: tests valid: { seconds: 5 }, { hours: 1, minutes: 30 }
  - acceptance: tests invalid: {}, null, "PT5S", { foo: 1 }, { seconds: "5" }

- [ ] **1.2.3** verify step 1.2
  - run: `npm run test:unit -- isIsoDurationShape`
  - verify: all tests pass

### step 1.3: create isIsoDuration guard

depends on: 1.1, 1.2

- [ ] **1.3.1** create `src/domain.operations/checks/isIsoDuration.ts`
  - acceptance: exports `isIsoDuration` function
  - acceptance: uses `withAssure` from type-fns
  - acceptance: returns true if `isIsoDurationWords` or `isIsoDurationShape`

- [ ] **1.3.2** create `src/domain.operations/checks/isIsoDuration.test.ts`
  - acceptance: tests accept both string and object formats
  - acceptance: tests reject invalid inputs

- [ ] **1.3.3** verify step 1.3
  - run: `npm run test:unit -- isIsoDuration`
  - verify: all tests pass

### phase 1 gate

- [ ] **1.gate** verify phase 1 complete
  - run: `npm run test:unit`
  - verify: all guard tests pass
  - verify: `isIsoDurationWords('PT5S')` returns true
  - verify: `isIsoDurationShape({ seconds: 5 })` returns true
  - verify: `isIsoDuration('PT5S')` returns true
  - verify: `isIsoDuration({ seconds: 5 })` returns true

---

## phase 2: cast operations

bidirectional conversion between formats.

### step 2.1: create asIsoDurationShape cast

depends on: 1.1

- [ ] **2.1.1** create `src/domain.operations/casts/asIsoDurationShape.ts`
  - acceptance: exports `asIsoDurationShape` function
  - acceptance: parses iso 8601 string to object
  - acceptance: handles fractional seconds
  - acceptance: throws `BadRequestError` for invalid input
  - acceptance: returns `{ seconds: 0 }` for zero duration

- [ ] **2.1.2** create `src/domain.operations/casts/asIsoDurationShape.test.ts`
  - acceptance: PT5S → { seconds: 5 }
  - acceptance: P1Y6M → { years: 1, months: 6 }
  - acceptance: P1DT2H30M → { days: 1, hours: 2, minutes: 30 }
  - acceptance: PT1.5S → { seconds: 1.5 }
  - acceptance: PT0S → { seconds: 0 }
  - acceptance: invalid input throws BadRequestError

- [ ] **2.1.3** verify step 2.1
  - run: `npm run test:unit -- asIsoDurationShape`
  - verify: all tests pass

### step 2.2: create asIsoDurationWords cast

depends on: 0.2

- [ ] **2.2.1** create `src/domain.operations/casts/asIsoDurationWords.ts`
  - acceptance: exports `asIsoDurationWords` function
  - acceptance: converts object to iso 8601 string
  - acceptance: merges milliseconds into fractional seconds
  - acceptance: omits zero-valued units
  - acceptance: returns `'PT0S'` for zero duration

- [ ] **2.2.2** create `src/domain.operations/casts/asIsoDurationWords.test.ts`
  - acceptance: { seconds: 5 } → "PT5S"
  - acceptance: { years: 1, months: 6 } → "P1Y6M"
  - acceptance: { days: 1, hours: 2, minutes: 30 } → "P1DT2H30M"
  - acceptance: { milliseconds: 500 } → "PT0.5S"
  - acceptance: { seconds: 1, milliseconds: 500 } → "PT1.5S"
  - acceptance: { seconds: 0 } → "PT0S"
  - acceptance: { weeks: 2 } → "P2W"
  - acceptance: { weeks: 2, days: 3 } → "P2W3D"

- [ ] **2.2.3** verify step 2.2
  - run: `npm run test:unit -- asIsoDurationWords`
  - verify: all tests pass

### step 2.3: create asIsoDurationShape helper

depends on: 2.1

- [ ] **2.3.1** create `src/domain.operations/casts/asIsoDurationShape.ts`
  - acceptance: exports `asIsoDurationShape` function
  - acceptance: returns parsed object for string input
  - acceptance: returns input as-is for object input

- [ ] **2.3.2** create `src/domain.operations/casts/asIsoDurationShape.test.ts`
  - acceptance: string input returns parsed object
  - acceptance: object input returns as-is

- [ ] **2.3.3** verify step 2.3
  - run: `npm run test:unit -- asIsoDurationShape`
  - verify: all tests pass

### phase 2 gate

- [ ] **2.gate** verify phase 2 complete
  - run: `npm run test:unit`
  - verify: all cast tests pass
  - verify: round-trip conversion preserves values:
    - `asIsoDurationShape(asIsoDurationWords({ hours: 2, minutes: 30 }))` equals `{ hours: 2, minutes: 30 }`

---

## phase 3: update operations

modify operations to accept IsoDuration (both formats).

### step 3.1: update toMilliseconds

depends on: 2.3

- [ ] **3.1.1** update `src/domain.operations/manipulate/toMilliseconds.ts`
  - acceptance: signature accepts `IsoDuration`
  - acceptance: normalizes input via `asIsoDurationShape`
  - acceptance: backwards compatible with object format

- [ ] **3.1.2** add tests to `src/domain.operations/manipulate/toMilliseconds.test.ts`
  - acceptance: toMilliseconds("PT1H") === 3600000
  - acceptance: toMilliseconds("PT1H30M") === toMilliseconds({ hours: 1, minutes: 30 })

- [ ] **3.1.3** verify step 3.1
  - run: `npm run test:unit -- toMilliseconds`
  - verify: all tests pass (old and new)

### step 3.2: update addDuration

depends on: 2.3

- [ ] **3.2.1** update `src/domain.operations/manipulate/addDuration.ts`
  - acceptance: signature accepts `IsoDuration`
  - acceptance: normalizes input via `asIsoDurationShape`
  - acceptance: backwards compatible with object format

- [ ] **3.2.2** add tests to `src/domain.operations/manipulate/addDuration.test.ts`
  - acceptance: addDuration(stamp, "PT1H") works
  - acceptance: addDuration(stamp, "PT1H") === addDuration(stamp, { hours: 1 })

- [ ] **3.2.3** verify step 3.2
  - run: `npm run test:unit -- addDuration`
  - verify: all tests pass (old and new)

### step 3.3: update subDuration

depends on: 2.3

- [ ] **3.3.1** update `src/domain.operations/manipulate/subDuration.ts`
  - acceptance: signature accepts `IsoDuration`
  - acceptance: normalizes input via `asIsoDurationShape`
  - acceptance: backwards compatible with object format

- [ ] **3.3.2** add tests to `src/domain.operations/manipulate/subDuration.test.ts`
  - acceptance: subDuration(stamp, "PT1H") works
  - acceptance: subDuration(stamp, "PT1H") === subDuration(stamp, { hours: 1 })

- [ ] **3.3.3** verify step 3.3
  - run: `npm run test:unit -- subDuration`
  - verify: all tests pass (old and new)

### step 3.4: update asDurationInWords

depends on: 2.3

- [ ] **3.4.1** update `src/domain.operations/manipulate/asDurationInWords.ts`
  - acceptance: signature accepts `IsoDuration`
  - acceptance: normalizes input via `asIsoDurationShape`
  - acceptance: backwards compatible with object format

- [ ] **3.4.2** add tests to `src/domain.operations/manipulate/asDurationInWords.test.ts`
  - acceptance: asDurationInWords("PT2H5M") === "2h 5m"

- [ ] **3.4.3** verify step 3.4
  - run: `npm run test:unit -- asDurationInWords`
  - verify: all tests pass (old and new)

### step 3.5: verify sleep with string format

depends on: 3.1

- [ ] **3.5.1** add tests to sleep test file
  - acceptance: sleep("PT0.01S") works without error

- [ ] **3.5.2** verify step 3.5
  - run: `npm run test:unit -- sleep`
  - verify: all tests pass

### step 3.6: verify waitFor with string format

depends on: 3.1

- [ ] **3.6.1** add tests to waitFor test file
  - acceptance: waitFor(fn, { interval: "PT0.01S", timeout: "PT1S" }) works

- [ ] **3.6.2** verify step 3.6
  - run: `npm run test:unit -- waitFor`
  - verify: all tests pass

### phase 3 gate

- [ ] **3.gate** verify phase 3 complete
  - run: `npm run test:unit`
  - verify: all operation tests pass
  - verify: all operations accept both string and object formats
  - verify: both formats produce identical results

---

## phase 4: exports

update public api to expose new types and operations.

### step 4.1: update index.ts

depends on: 0.3, 1.3, 2.2, 2.1

- [ ] **4.1.1** update `src/index.ts`
  - acceptance: exports `IsoDuration`, `IsoDurationWords`, `IsoDurationShape`
  - acceptance: exports `isIsoDuration`, `isIsoDurationWords`, `isIsoDurationShape`
  - acceptance: exports `asIsoDurationShape`, `asIsoDurationWords`

- [ ] **4.1.2** verify step 4.1
  - run: `npm run test:types`
  - verify: no type errors
  - run: `npm run build`
  - verify: build succeeds

### phase 4 gate

- [ ] **4.gate** verify phase 4 complete
  - run: `npm run build`
  - verify: build succeeds
  - verify: all new types and operations are exported

---

## phase 5: acceptance tests

verify end-to-end behavior via blackbox tests.

### step 5.1: add acceptance tests

depends on: 4.1

- [ ] **5.1.1** update `blackbox/iso-time.acceptance.test.ts`
  - acceptance: tests duration declared via string format
  - acceptance: tests duration strings validated
  - acceptance: tests format conversion round-trip
  - acceptance: tests operations with string durations
  - acceptance: tests both formats produce identical results

- [ ] **5.1.2** verify step 5.1
  - run: `npm run test:acceptance:locally`
  - verify: all acceptance tests pass

### phase 5 gate

- [ ] **5.gate** verify phase 5 complete
  - run: `npm run test:acceptance:locally`
  - verify: all acceptance tests pass

---

## final verification

- [ ] **final.1** full test suite
  - run: `npm run test`
  - verify: all tests pass (types, unit, integration, acceptance)

- [ ] **final.2** build verification
  - run: `npm run build`
  - verify: build succeeds with no errors

- [ ] **final.3** blackbox criteria verification
  - verify: usecase.1 = declare duration via string format ✓
  - verify: usecase.2 = declare duration via object format (current behavior) ✓
  - verify: usecase.3 = validate duration strings ✓
  - verify: usecase.4 = cast string to duration and vice versa ✓
  - verify: usecase.5 = operations accept both formats isomorphically ✓
  - verify: usecase.6 = getDuration returns duration shape (not string) ✓
  - verify: usecase.7 = asDurationInWords supports both formats ✓
  - verify: usecase.8 = edge cases and boundary conditions ✓
  - verify: usecase.9 = type guards narrow IsoDuration type ✓
  - verify: usecase.10 = stopwatch returns duration object ✓

---

## dependency graph

```
pre.1, pre.2
    │
    ├── 0.1 (IsoDurationWords) ─────┐
    │                               │
    ├── 0.2 (IsoDurationShape) ─────┼── 0.3 (IsoDuration)
    │       │                       │         │
    │       │                       │         │
    │       ├── 1.2 (isIsoDurationShape)      │
    │       │           │                     │
    │       │           └─────────────────────┼── 1.3 (isIsoDuration)
    │       │                                 │         │
    │       └── 2.2 (asIsoDurationWords)      │         │
    │                                         │         │
    └── 1.1 (isIsoDurationWords) ─────────────┘         │
                │                                       │
                └── 2.1 (asIsoDurationShape)            │
                            │                           │
                            └── 2.3 (asIsoDurationShape)
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                3.1 (toMilliseconds) 3.2 (addDuration) 3.3 (subDuration)
                    │                   │                   │
                    ├───────────────────┼───────────────────┤
                    │                   │                   │
                3.5 (sleep)         3.4 (asDurationInWords) │
                    │                                       │
                3.6 (waitFor)                               │
                    │                                       │
                    └───────────────────┬───────────────────┘
                                        │
                                    4.1 (exports)
                                        │
                                    5.1 (acceptance)
                                        │
                                    final verification
```

---

## summary

| phase | steps | dependencies | verification |
|-------|-------|--------------|--------------|
| 0 | 3 | none | test:types, test:unit |
| 1 | 3 | phase 0 | test:unit |
| 2 | 3 | phase 0, 1 | test:unit |
| 3 | 6 | phase 2 | test:unit |
| 4 | 1 | phase 0-2 | test:types, build |
| 5 | 1 | phase 4 | test:acceptance |
| final | 3 | all | full test suite |

total: 20 steps + 3 final verifications
